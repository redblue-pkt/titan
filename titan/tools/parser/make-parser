#!/bin/sh
SVNUSER=$1
SVNPASS=$2
SVNURL=$3

if [ $# -ne 3 ]; then
	echo "|---------------------------------------------------------------------------------------------|"
	echo "|                                                                                             |"
	echo "| Parser Make Script                                                                          |"
	echo "|                                                                                             |"
	echo '| use ./make-parser <svnuser> <svnpass> <svnurl>                                                 |'
	echo "|                                                                                             |"
	echo "| for svnuser <your>                                                                          |"
	echo "| for svnpass <your>                                                                          |"
	echo "| for svnurl <your>                                                                           |"
	echo "|                                                                                             |"
	echo "|---------------------------------------------------------------------------------------------|"
	echo "|                                                                            v2.1@dev-team    |"
	echo "|---------------------------------------------------------------------------------------------|"
	exit 1
fi

if [ ! -e "$HOME"/make-svn/logs/parser ];then
	mkdir -p "$HOME"/make-svn/logs/parser
fi

HOMEDIR=`pwd`
TMP=.tmp

rm -rf "$HOME"/parser/BUILD
mkdir -p "$HOME"/parser/BUILD
cd "$HOME"/parser/BUILD

svn co --username $SVNUSER --password $SVNPASS http://"$SVNURL"/svn/titan/skins/tithek/tithekmainmenu "$HOME"/parser/BUILD/mediathek
svn co --username $SVNUSER --password $SVNPASS http://"$SVNURL"/svn/titan/skins/tithek/menu "$HOME"/parser/BUILD/mediathek/menu
version=`svn info --username $SVNUSER --password $SVNPASS http://"$SVNURL"/svn/titan | grep Revision | sed s/'Revision: '//g`

rm -rf `find "$HOME"/parser/BUILD/mediathek -type d -name "*.svn"`

rm -rf /var/www/atemio/web/mediathek/menu
rm -rf /var/www/atemio/web/mediathek/*.list
mv -f "$HOME"/parser/BUILD/mediathek/* /var/www/atemio/web/mediathek
mv -f "$HOME"/parser/*.sh "$HOME"/parser/BUILD

# disable beeg
#rm "$HOME"/parser/BUILD/beeg.sh
#rm "$HOME"/parser/BUILD/kinox.sh
#rm "$HOME"/parser/BUILD/myvideo.sh
#rm "$HOME"/parser/BUILD/netzkino.sh
#rm "$HOME"/parser/BUILD/rtl2now.sh
#rm "$HOME"/parser/BUILD/rtl-now.sh
#rm "$HOME"/parser/BUILD/solarmovie.sh
#rm "$HOME"/parser/BUILD/superrtlnow.sh
#rm "$HOME"/parser/BUILD/voxnow.sh
#rm "$HOME"/parser/BUILD/youtube.sh
#rm "$HOME"/parser/BUILD/zdf.sh
#rm "$HOME"/parser/BUILD/movie4k.sh
#rm "$HOME"/parser/BUILD/xvideos.sh
#rm "$HOME"/parser/BUILD/drdish.sh
#rm "$HOME"/parser/BUILD/mlehd.sh
#rm "$HOME"/parser/BUILD/giga.sh

lasttimestamp=`cat /var/www/atemio/web/mediathek/lasttimestamp`
lasttimestamp=`expr $lasttimestamp + 84500`
today=`date +%s`

echo today $today
echo lasttimestamp $lasttimestamp

#ls -1 "$HOME"/parser/BUILD/*.sh | sort -r > tmp.txt
ls -1 "$HOME"/parser/BUILD/*.sh > tmp.txt
	
if [ $today -gt $lasttimestamp ];then
#	ls -1 "$HOME"/parser/BUILD/*.sh | sort -r > tmp.txt
	PARSETYPE=full
else
	echo else
#	ls -1 "$HOME"/parser/BUILD/*.sh | grep -v beeg.sh > "$HOME"/parser/BUILD/tmp.txt
	PARSETYPE=fast
fi

BEGINTIME=`date +%s`
DATENAME=`date +"%Y.%m.%d_%H.%m.%S"`
echo "[make-parser] START (buildtype: $PARSETYPE): $DATENAME" > "$HOME"/make-svn/logs/parser/m"$version"_"$DATENAME".smal.log

if [ ! -e /var/www/atemio/web/mediathek ];then
	mkdir -p /var/www/atemio/web/mediathek
fi

LINE=`cat "$HOME"/parser/BUILD/tmp.txt`

echo "LINE: $LINE" >> "$HOME"/make-svn/logs/parser/m"$version"_"$DATENAME".smal.log

echo LINE $LINE
for ROUND in $LINE; do
	cd "$HOME"/parser/BUILD
	FILE=`echo $ROUND | tr '/' '\n' | tail -n1`
	FILENAME=`echo $ROUND | tr '/' '\n' | tail -n1 | sed 's/\.sh//'`
	if [ $FILE == "beeg.sh" ];then
		echo `date +%s` >/var/www/atemio/web/mediathek/lasttimestamp
	fi
	echo "######################## $ROUND"
	echo "######################## parse $ROUND ($FILENAME $PARSETYPE)" >> "$HOME"/make-svn/logs/parser/m"$version"_"$DATENAME".smal.log

	$ROUND $PARSETYPE
	echo "[make-parser] make $ROUND"
	STARTTIME=`date +"%Y.%m.%d_%H.%M.%S"`
	
	cd "$HOME"/parser/BUILD/_full
	cat "$HOME"/parser/BUILD/_full/"$FILENAME"/build.log >> "$HOME"/make-svn/logs/parser/m"$version"_"$DATENAME".smal.log

	if [ $PARSETYPE = "fast" ]; then
		echo "######################## $ROUND $PARSETYPE > continue"
		continue
	fi

	LINE1=`ls -1`
	TIME=`date +"%Y.%m.%d_%H.%M.%S"`
	echo "######################## move"	
	for TYPE in $LINE1; do
		if [ $TYPE == $FILENAME ];then 
			mv $TYPE /var/www/atemio/web/mediathek/"$TYPE"_"$TIME"
			echo "[make-parser]" mv "$TYPE" "> /var/www/atemio/web/mediathek/""$TYPE"_"$TIME"
			rm -rf /var/www/atemio/web/mediathek/"$TYPE"
			echo "[make-parser]" ln -s "$TYPE"_"$TIME" /var/www/atemio/web/mediathek/"$TYPE"
			ln -s "$TYPE"_"$TIME" /var/www/atemio/web/mediathek/"$TYPE"
		
			BSLIST=`ls -1 /var/www/atemio/web/mediathek | grep "$TYPE"_ | tail -n20`
			BFLIST=`ls -1 /var/www/atemio/web/mediathek | grep "$TYPE"_`
			for ROUND1 in $BFLIST; do
				skip=0
				for ROUND2 in $BSLIST; do
					echo [Backup] ROUND1 $ROUND1
					echo [Backup] ROUND2 $ROUND2
					if [ $ROUND1 = $ROUND2 ]; then
						echo [Backup] set skip=1
						skip=1
					fi
					if [ $ROUND1 = ".." ] || [ $ROUND2 = ".." ] || [ $ROUND1 = "." ] || [ $ROUND2 = "." ]; then
						echo [Backup] set skip=1
						skip=1
					fi
				done
				echo [Backup] skip $skip
				if [ $skip = 0 ]; then	
					echo [Backup] start remove user backups
					rm -rf /var/www/atemio/web/mediathek/"$ROUND1"
				fi
			done	
		fi
	done
	echo "######################## done"
	cd "$HOME"/parser/BUILD
done

DONETIME=`date +%s`
TIME=`expr $DONETIME - $BEGINTIME`
echo "[make-parser] build time: ($TIME s) done" >> "$HOME"/make-svn/logs/parser/m"$version"_"$DATENAME".smal.log	
